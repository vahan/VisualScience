<?php

/**
 * @file
 * The VisualScience Module, from QScience.
 *
 * It allows you to sort, contact and more generally visualize scientific data about you users.
 */

//Tools pre-made by Vahe
require_once 'includes/visualscience.settings.inc';
require_once 'includes/visualscience.utils.inc';

//Classes for each functionality
require_once 'includes/visualscience.searchtable.class.php';
include_once 'includes/visualscience.message.class.php';
include_once 'includes/visualscience.upload.class.php';
include_once 'includes/visualscience.config.class.php';

define('VISUALSCIENCE_NUSER_LOADED', 1000);


/**
 * Implements hook_menu.
 * @return array Arraay of all possible urls for VisualScience module
 */
function visualscience_menu() {

  $items['visualscience'] = array(
    'title' => 'Visual Science',
    'description' => 'Visual Science description',
    'page callback' => 'visualscience_page',
    'access arguments' => array('access visualscience'),
    // 'access callback' => TRUE,
    'weight' => 30,
    );

  $items['visualscience/users'] = array(
    'title' => 'VisualScience Users Access',
    'description' => 'Get Users of VisualScience',
    'page callback' => 'visualscience_users',
    'access arguments' => array('access visualscience'),
    'type' => MENU_CALLBACK,
    );

  $items['visualscience/upload'] = array(
    'title' => 'VisualScience Upload',
    'description' => 'Upload a file in VisualScience',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('visualscience_upload_form'),
    'access arguments' => array('access visualscience'),
    'type' => MENU_CALLBACK,
    );

  $items['visualscience/file'] = array(
    'title' => 'VisualScience Attachment Access',
    'description' => 'Access a file uploaded from VisualScience',
    'page callback' => 'visualscience_get_file_with_id',
    // 'access callback' => TRUE,
    'type' => MENU_CALLBACK,
    );

  $items['visualscience/mail'] = array(
    'title' => 'VisualScience Mail Send',
    'description' => 'Send Mail from VisualScience',
    'page callback' => 'visualscience_send_message',
    'access arguments' => array('access visualscience'),
    'type' => MENU_CALLBACK,
    );

  $items['admin/config/media/visualscience'] = array(
    'title' => 'VisualScience Configuration',
    'description' => 'Configuration for the VisualScience module.',
    'page callback' => 'visualscience_config_page',
    'access arguments' => array('administer site configuration'),
    'type' => MENU_NORMAL_ITEM,
    );

  return $items;
}

/**
 * Form to upload a file to VisualScience
 * @param  form $form       Drupal-generated
 * @param  form-state $form_state Drupal-generated
 * @return string             HTML with form to be printed
 */
function visualscience_upload_form($form, &$form_state) {
  $upload = new Upload;
  return $upload->visualscience_upload_form($form, $form_state);
}

/**
 * Getting the file securely
 * @return file if denied a webpage else the requested file
 */
function visualscience_get_file_with_id() {
  $upload = new Upload;
  return $upload->visualscience_get_file_with_id();
}

/**
 * Sending an email throught this Drupal's installation
 * @return string notification if success or error
 */
function visualscience_send_message() {
  $message = new Message;
  return $message->visualscience_send_message();
}

/**
 * Backend when a file has to be uploaded
 * @param  Drupal $form       automatically generated by Drupal
 * @param  Drupal $form_state automatically generated by Drupal
 * @return string             Notification if success or error and informations about it
 */
function visualscience_upload_submit($form, &$form_state) {
  $upload = new Upload;
  return $upload->visualscience_upload_submit($form, $form_state);
}

/**
 * The main webpage for VisualScience
 * @param  boolean $clear Drupal-generated
 * @return string         The webpage to be printed
 */
function visualscience_page($clear = TRUE) {
  $search = new Search;
  $search_to_perform = $search->getSavedSearch();
  $search->getClientSideFiles();
  $search_bar = $search->getHtmlSearchBar($search_to_perform);
  $search_table = $search->getHtmlsearchTable();
  $output = $search_bar . $search_table;
  return $output;
}

/**
 * Configuration page for the VisualScience module
 * @param  boolean $clear Whether the form is cleared or not(Drupal-generated)
 * @return string         The page to be displayed
 */
function visualscience_config_page($clear = TRUE) {
  $config = new Config;
  $output = '';
  if (isset($_POST['visualscience_config_form']) && $_POST['visualscience_config_csrf_token'] == $_COOKIE['csrfTokenValue']) {
    $config->saveSentValues();
    drupal_set_message(t('Configuration Saved !'), 'status');
  }
  $output .= $config->getHtmlConfigPage();
  return $output;
}

/**
 * Backend to get the list of users from the server
 * @return json the list of users with some additional informations
 */
function visualscience_users() {
  $search = new Search;
  $from = intval($_GET['userId']);
  $database = $search->getUsersEntries($from, variable_get('visualscience_user_sent_per_ajax_request', 1000));
  echo $database;
}

/**
 * We want to change the CSS of jQuery, because when using the selector they propose, 
 * we don't have the expected performance. (Really slow with > 10'000 checkboxes)
 * @param  array $css Drupal's array of CSS
 * @return none      we just modify the link of a file, don't return anything.
 */
function visualscience_css_alter(&$css) {
  if (isset($css['misc/ui/jquery.ui.theme.css'])) {
    $css['misc/ui/jquery.ui.theme.css']['data'] = drupal_get_path('module', 'visualscience') . '/css/visualscience.jquery.ui.theme.css';
  }
}